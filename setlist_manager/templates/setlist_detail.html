{% extends "base.html" %}

{% block title %}{{ setlist.name }} ¬∑ Setlist Manager{% endblock %}

{% block content %}
<div class="setlist-workspace">
    <!-- Left Column: Setlist Details -->
    <div class="setlist-column">
        <section class="panel">
            <header>
                <h2>{{ setlist.name }}</h2>
                <div class="panel-actions">
                    <a class="button" href="{{ url_for('setlists.print_setlist', setlist_id=setlist.id) }}" target="_blank" rel="noopener">
                        Generate PDF
                    </a>
                    <button type="button" class="button" onclick="sendToTimer({{ setlist.id }})" id="sendToTimerBtn">
                        Send to Timer
                    </button>
                    <form method="post" action="{{ url_for('setlists.delete_setlist', setlist_id=setlist.id) }}" onsubmit="return confirm('Delete this setlist?');">
                        <button type="submit" class="danger">Delete</button>
                    </form>
                </div>
            </header>
            {% if setlist.description %}
                <p class="setlist-description">{{ setlist.description }}</p>
            {% endif %}
            <dl class="setlist-meta">
                <div>
                    <dt>Total Duration</dt>
                    <dd>{{ setlist.total_duration_label }}</dd>
                </div>
                <div>
                    <dt>Song Duration</dt>
                    <dd>{{ setlist.song_duration_label }}</dd>
                </div>
                <div>
                    <dt>Target Duration</dt>
                    <dd>{{ setlist.target_duration_label }}</dd>
                </div>
                <div>
                    <dt>Songs</dt>
                    <dd>{{ setlist.entries|length }}</dd>
                </div>
                {% if setlist.show_date %}
                <div>
                    <dt>Show Date</dt>
                    <dd>{{ setlist.show_date.strftime('%b %d, %Y') }}</dd>
                </div>
                {% endif %}
                <div>
                    <dt>Created</dt>
                    <dd>{{ setlist.created_at.strftime('%b %d, %Y %H:%M') }}</dd>
                </div>
            </dl>
            {% if setlist.entries and setlist.encore_break_count %}
                {% set encore_breaks = setlist.encore_break_count %}
                <p class="hint">
                    Total includes {{ encore_breaks }} 4-minute encore break{% if encore_breaks != 1 %}s{% endif %}.
                </p>
            {% endif %}

            {% if setlist.target_duration_seconds and setlist.entries %}
                <form method="post" action="{{ url_for('setlists.regenerate_setlist', setlist_id=setlist.id) }}" class="inline-form" onsubmit="return confirm('Regenerate using your target duration? This replaces the current order.');">
                    <button type="submit">Regenerate Automatically</button>
                </form>
            {% endif %}
            {% if setlist.entries %}
                <form method="post" action="{{ url_for('setlists.add_encore_break', setlist_id=setlist.id) }}" class="inline-form">
                    <button type="submit">Add Encore Break</button>
                </form>
            {% endif %}

            <!-- Show Date and Time Form -->
            <form
                method="post"
                action="{{ url_for('setlists.update_show_date', setlist_id=setlist.id) }}"
                class="show-time-form"
            >
                <div class="show-time-inputs">
                    <div>
                        <label for="show-date-input">
                            Show Date
                            <input
                                type="date"
                                id="show-date-input"
                                name="show_date"
                                value="{{ setlist.show_date.isoformat() if setlist.show_date else '' }}"
                            >
                        </label>
                    </div>
                    <div>
                        <label for="show-start-time">
                            Start Time
                            <input
                                type="time"
                                id="show-start-time"
                                name="show_start_time"
                                value="{{ setlist.show_start_time.strftime('%H:%M') if setlist.show_start_time else '' }}"
                                placeholder="8:00 PM"
                            >
                        </label>
                    </div>
                    <div>
                        <label for="show-end-time">
                            End Time
                            <input
                                type="time"
                                id="show-end-time"
                                name="show_end_time"
                                value="{{ setlist.show_end_time.strftime('%H:%M') if setlist.show_end_time else '' }}"
                                placeholder="9:00 PM"
                            >
                        </label>
                    </div>
                </div>
                <div class="show-time-buttons">
                    <button type="submit" name="action" value="save">Save Times</button>
                    {% if setlist.show_date or setlist.show_start_time or setlist.show_end_time %}
                        <button type="submit" name="action" value="clear" class="secondary-button">
                            Clear All
                        </button>
                    {% endif %}
                </div>
            </form>

            <!-- Duration Warning -->
            {% if setlist.show_duration_warning %}
                <div class="duration-warning alert">
                    {{ setlist.show_duration_warning }}
                </div>
            {% endif %}

            <!-- Duration Comparison -->
            {% if setlist.show_start_time and setlist.show_end_time %}
                <div class="duration-comparison">
                    <h4>Duration Summary</h4>
                    <dl>
                        <div>
                            <dt>Show Duration</dt>
                            <dd>{{ setlist.show_duration_label }}</dd>
                        </div>
                        <div>
                            <dt>Setlist Duration</dt>
                            <dd>{{ setlist.total_duration_label }}</dd>
                        </div>
                        <div>
                            <dt>Difference</dt>
                            <dd class="{{ 'over-time' if setlist.exceeds_show_duration else 'under-time' }}">
                                {{ setlist.duration_difference_label }}
                            </dd>
                        </div>
                    </dl>
                </div>
            {% endif %}
        </section>

        <section class="panel">
            <header>
                <h3>Order</h3>
            </header>

            {% if setlist.entries %}
                <table class="data-table" data-setlist-table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th class="sr-only">Reorder</th>
                            <th>Title</th>
                            <th>Artist</th>
                            <th>Tags</th>
                            <th>Duration</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody data-setlist-body data-reorder-url="{{ url_for('setlists.reorder_setlist', setlist_id=setlist.id) }}">
                        {% set encore_counter = namespace(value=0) %}
                        {% for entry in setlist.entries %}
                            {% if entry.starts_encore and loop.index > 1 %}
                                {% set encore_counter.value = encore_counter.value + 1 %}
                                <tr class="encore-break">
                                    <td colspan="7">Encore {{ encore_counter.value }}</td>
                                </tr>
                            {% endif %}
                            <tr data-entry-id="{{ entry.id }}">
                                <td data-position-cell>{{ loop.index }}</td>
                                <td class="drag-cell">
                                    <button type="button" data-drag-handle draggable="true" class="drag-handle" aria-label="Drag to reorder">‚ò∞</button>
                                </td>
                                <td>{{ entry.song.title }}</td>
                                <td>{{ entry.song.artist }}</td>
                                <td>
                                    {% if entry.song.tag_summary %}
                                        {{ entry.song.tag_summary }}
                                    {% else %}
                                        ‚Äî
                                    {% endif %}
                                </td>
                                <td>{{ entry.song.duration_label }}</td>
                                <td class="actions">
                                    <div class="dropdown">
                                        <button class="dropdown-toggle" onclick="toggleDropdown(event, 'dropdown-{{ entry.id }}')">
                                            <span aria-hidden="true">‚ãØ</span>
                                            <span class="sr-only">Actions</span>
                                        </button>
                                        <div id="dropdown-{{ entry.id }}" class="dropdown-menu">
                                            {% if entry.starts_encore %}
                                                <button class="dropdown-item" onclick="removeEncore('{{ url_for('setlists.remove_encore_break', setlist_id=setlist.id, entry_id=entry.id) }}')">
                                                    <span class="dropdown-icon">üé≠</span>
                                                    Remove Encore Break
                                                </button>
                                            {% else %}
                                                <button class="dropdown-item" onclick="addEncore('{{ url_for('setlists.add_encore_break_at_position', setlist_id=setlist.id, entry_id=entry.id) }}', event)">
                                                    <span class="dropdown-icon">‚ûï</span>
                                                    Add Encore Break
                                                </button>
                                            {% endif %}
                                            <button class="dropdown-item danger-item" onclick="removeSong(this, '{{ url_for('setlists.remove_setlist_entry', setlist_id=setlist.id, entry_id=entry.id) }}')">
                                                <span class="dropdown-icon">üóëÔ∏è</span>
                                                Remove Song
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No songs in this setlist yet. Add songs from the library on the right to get started.</p>
            {% endif %}
        </section>
    </div>

    <!-- Right Column: Song Library -->
    <div class="library-column">
        <section class="panel secondary">
            <header>
                <h3>Song Library</h3>
            </header>
            {% if available_songs %}
                <div class="songs-browser" data-setlist-id="{{ setlist.id }}">
                    <div class="search-controls">
                        <input type="text" id="song-search" placeholder="Search songs by title, artist, or genre..." class="search-input">
                        <div class="filter-controls">
                            <select id="sort-select" class="filter-select">
                                <option value="title">Sort by Title</option>
                                <option value="artist">Sort by Artist</option>
                                <option value="duration">Sort by Duration</option>
                                <option value="energy">Sort by Energy</option>
                                <option value="plays">Sort by Plays</option>
                                <option value="last_played">Sort by Last Played</option>
                            </select>
                            <select id="genre-filter" class="filter-select">
                                <option value="">All Genres</option>
                            </select>
                            <select id="tag-filter" class="filter-select">
                                <option value="">All Tags</option>
                                <option value="M">Multitrack</option>
                                <option value="CVR">Cover</option>
                                <option value="VO">Vocals Only</option>
                            </select>
                        </div>
                    </div>
                    <div class="available-songs-list" id="available-songs-container">
                        <!-- Songs will be loaded here via JavaScript -->
                    </div>
                </div>
            {% else %}
                <p>Every song in your library is already in this setlist. <a href="{{ url_for('setlists.songs') }}">Add more songs</a>.</p>
            {% endif %}
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='setlist.js') }}?v=1752167512" defer></script>
<script src="{{ url_for('static', filename='song-browser.js') }}" defer></script>
<script>
// Send to Timer functionality
function sendToTimer(setlistId) {
    const btn = document.getElementById('sendToTimerBtn');
    const originalText = btn.textContent;

    btn.textContent = 'Sending...';
    btn.disabled = true;

    fetch(`/setlists/${setlistId}/send-to-timer`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            btn.textContent = 'Sent!';
            btn.classList.add('success');
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.classList.remove('success');
            }, 3000);
        } else {
            throw new Error(data.error || 'Failed to send to timer');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending to timer: ' + error.message);
        btn.textContent = originalText;
        btn.disabled = false;
    });
}

// Dropdown menu functionality
function toggleDropdown(event, dropdownId) {
    event.preventDefault();
    event.stopPropagation();

    const dropdown = document.getElementById(dropdownId);
    const allDropdowns = document.querySelectorAll('.dropdown-menu');

    // Close all other dropdowns
    allDropdowns.forEach(d => {
        if (d.id !== dropdownId) {
            d.classList.remove('show');
        }
    });

    // Toggle current dropdown
    dropdown.classList.toggle('show');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const dropdowns = document.querySelectorAll('.dropdown-menu');
    dropdowns.forEach(dropdown => {
        if (!dropdown.contains(event.target)) {
            dropdown.classList.remove('show');
        }
    });
});

// Handle song removal using the clicked element (no reliance on global event)
function removeSong(triggerEl, url) {
    const dropdownItem = triggerEl ? triggerEl.closest('.dropdown-item') : null;
    const dropdown = dropdownItem ? dropdownItem.parentElement : null;
    const dropdownToggle = dropdown ? dropdown.querySelector('.dropdown-toggle') : null;
    const button = dropdownToggle;

    const entryMatch = url.match(/entries\/([0-9]+)/);
    const entryId = entryMatch ? entryMatch[1] : null;
    const row = triggerEl ? triggerEl.closest('tr') : null;
    const fallbackRow = entryId ? document.querySelector(`[data-entry-id="${entryId}"]`) : null;
    const originalText = button ? button.textContent : '';

    if (!confirm('Remove this song from the setlist?')) {
        return false;
    }

    if (button) {
        button.textContent = 'Removing...';
        button.disabled = true;
    }

    fetch(url, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: ''
    })
    .then(response => {
        console.log('Remove song response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Remove song response data:', data);
        if (data.status === 'success') {
            // Remove the row immediately without page reload
            (row || fallbackRow)?.remove();

            // Update setlist metadata
            try {
                updateSetlistMetadataFast(data);
            } catch (e) {
                console.error('Error updating metadata:', e);
            }

            // Add song back to available list
            try {
                if (window.refreshAvailableSongs) {
                    window.refreshAvailableSongs();
                }
            } catch (e) {
                console.error('Error refreshing available songs:', e);
            }
        } else {
            if (button) {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (button) {
            button.textContent = originalText;
            button.disabled = false;
        }
        alert('Error removing song. Please try again.');
    });

    return false;
}
// Fast metadata update for AJAX responses
function updateSetlistMetadataFast(data) {
    const dts = document.querySelectorAll("dt");
    dts.forEach(dt => {
        if (dt.textContent.includes("Songs")) {
            const dd = dt.nextElementSibling;
            if (dd && dd.tagName === "DD") {
                dd.textContent = data.new_song_count;
            }
        }
        if (dt.textContent.includes("Total Duration")) {
            const dd = dt.nextElementSibling;
            if (dd && dd.tagName === "DD") {
                dd.textContent = data.new_duration;
            }
        }
    });
}

function removeEncore(url) {
    if (confirm('Remove this encore break?')) {
        fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: ''
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Fallback to form submission
            window.location.href = url;
        });
    }
}

function addEncore(url, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }

    if (confirm('Add an encore break after this song?')) {
        // Show loading state - find the dropdown toggle button
        const dropdownItem = event?.target ? event.target.closest('.dropdown-item') : null;
        const dropdown = dropdownItem ? dropdownItem.parentElement : null;
        const dropdownToggle = dropdown ? dropdown.querySelector('.dropdown-toggle') : null;
        const button = dropdownToggle;
        const originalText = button ? button.textContent : '';

        if (button) {
            button.textContent = 'Adding...';
            button.disabled = true;
        }

        fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: ''
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Reload page for encore changes (they affect layout significantly)
                window.location.reload();
            } else {
                button.textContent = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            button.textContent = originalText;
            button.disabled = false;
            // Fallback to form submission
            window.location.href = url;
        });
    }
}

// Close dropdowns on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const dropdowns = document.querySelectorAll('.dropdown-menu.show');
        dropdowns.forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
});

// Set default PM times for empty time fields
const startTimeInput = document.getElementById('show-start-time');
const endTimeInput = document.getElementById('show-end-time');

function setDefaultPMTime(input, defaultHour) {
    if (input && !input.value) {
        input.value = `${defaultHour.toString().padStart(2, '0')}:00`;
    }
}

// Set defaults when fields are focused
startTimeInput?.addEventListener('focus', function() {
    setDefaultPMTime(this, 20); // 8:00 PM (20:00)
});

endTimeInput?.addEventListener('focus', function() {
    setDefaultPMTime(this, 21); // 9:00 PM (21:00)
});

// Also set defaults on page load if fields are empty
document.addEventListener('DOMContentLoaded', function() {
    setDefaultPMTime(startTimeInput, 20); // 8:00 PM (20:00)
    setDefaultPMTime(endTimeInput, 21);   // 9:00 PM (21:00)
});
</script>
{% endblock %}
