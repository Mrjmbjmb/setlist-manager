{% extends "base.html" %}

{% block title %}{{ setlist.name }} ¬∑ Setlist Manager{% endblock %}

{% block content %}
<section class="panel">
    <header>
        <h2>{{ setlist.name }}</h2>
        <div class="panel-actions">
            <a class="button" href="{{ url_for('setlists.print_setlist', setlist_id=setlist.id) }}" target="_blank" rel="noopener">
                Generate PDF
            </a>
            <form method="post" action="{{ url_for('setlists.delete_setlist', setlist_id=setlist.id) }}" onsubmit="return confirm('Delete this setlist?');">
                <button type="submit" class="danger">Delete</button>
            </form>
        </div>
    </header>
    {% if setlist.description %}
        <p class="setlist-description">{{ setlist.description }}</p>
    {% endif %}
    <dl class="setlist-meta">
        <div>
            <dt>Total Duration</dt>
            <dd>{{ setlist.total_duration_label }}</dd>
        </div>
        <div>
            <dt>Target Duration</dt>
            <dd>{{ setlist.target_duration_label }}</dd>
        </div>
        <div>
            <dt>Songs</dt>
            <dd>{{ setlist.entries|length }}</dd>
        </div>
        <div>
            <dt>Created</dt>
            <dd>{{ setlist.created_at.strftime('%b %d, %Y %H:%M') }}</dd>
        </div>
    </dl>
    {% if setlist.entries %}
        {% set encore_breaks = setlist.encore_break_count %}
        <p class="hint">
            Total includes 30-second transitions between songs{% if encore_breaks %} and {{ encore_breaks }} 4-minute encore break{% if encore_breaks != 1 %}s{% endif %}{% endif %}.
        </p>
    {% endif %}

    {% if setlist.target_duration_seconds and setlist.entries %}
        <form method="post" action="{{ url_for('setlists.regenerate_setlist', setlist_id=setlist.id) }}" class="inline-form" onsubmit="return confirm('Regenerate using your target duration? This replaces the current order.');">
            <button type="submit">Regenerate Automatically</button>
        </form>
    {% endif %}
</section>

<section class="panel">
    <header>
        <h3>Order</h3>
    </header>

    {% if setlist.entries %}
        <table class="data-table" data-setlist-table>
            <thead>
                <tr>
                    <th>#</th>
                    <th class="sr-only">Reorder</th>
                    <th>Title</th>
                    <th>Print Name</th>
                    <th>Artist</th>
                    <th>Tags</th>
                    <th>Duration</th>
                    <th></th>
                </tr>
            </thead>
            <tbody data-setlist-body data-reorder-url="{{ url_for('setlists.reorder_setlist', setlist_id=setlist.id) }}">
                {% set encore_counter = namespace(value=0) %}
                {% for entry in setlist.entries %}
                    {% if entry.starts_encore and loop.index > 1 %}
                        {% set encore_counter.value = encore_counter.value + 1 %}
                        <tr class="encore-break">
                            <td colspan="8">Encore {{ encore_counter.value }}</td>
                        </tr>
                    {% endif %}
                    <tr data-entry-id="{{ entry.id }}">
                        <td data-position-cell>{{ loop.index }}</td>
                        <td class="drag-cell">
                            <button type="button" data-drag-handle draggable="true" class="drag-handle" aria-label="Drag to reorder">‚ò∞</button>
                        </td>
                        <td>{{ entry.song.title }}</td>
                        <td>
                            {% if entry.song.alias %}
                                {{ entry.song.alias }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td>{{ entry.song.artist }}</td>
                        <td>
                            {% if entry.song.tag_summary %}
                                {{ entry.song.tag_summary }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td>{{ entry.song.duration_label }}</td>
                        <td class="actions">
                            <form method="post" action="{{ url_for('setlists.move_setlist_entry', setlist_id=setlist.id, entry_id=entry.id) }}">
                                <button type="submit" name="direction" value="up" {% if loop.first %}disabled{% endif %}>‚Üë</button>
                                <button type="submit" name="direction" value="down" {% if loop.last %}disabled{% endif %}>‚Üì</button>
                            </form>
                            <form method="post" action="{{ url_for('setlists.toggle_encore_entry', setlist_id=setlist.id, entry_id=entry.id) }}">
                                {% if entry.starts_encore %}
                                    <button type="submit" class="link-button">Remove Encore Break</button>
                                {% else %}
                                    <button type="submit" class="link-button" {% if loop.first %}disabled title="Encore break must follow at least one song."{% endif %}>Add Encore Break</button>
                                {% endif %}
                            </form>
                            <form method="post" action="{{ url_for('setlists.remove_setlist_entry', setlist_id=setlist.id, entry_id=entry.id) }}" onsubmit="return confirm('Remove this song from the setlist?');">
                                <button type="submit" class="link-button">
                                    <span aria-hidden="true">üóëÔ∏è</span>
                                    <span class="sr-only">Remove from setlist</span>
                                </button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No songs in this setlist yet.</p>
    {% endif %}
</section>

<section class="panel secondary">
    <header>
        <h3>Add Song</h3>
    </header>
    {% if available_songs %}
        <form method="post" action="{{ url_for('setlists.add_song_to_setlist', setlist_id=setlist.id) }}">
            <label>
                Song
                <select name="song_id" required>
                    <option value="">Choose a song‚Ä¶</option>
                    {% for song in available_songs %}
                        <option value="{{ song.id }}">
                            {{ song.title }}{% if song.alias %} ‚Üí {{ song.alias }}{% endif %} ‚Äî {{ song.artist }} ({{ song.duration_label }}){% if song.tag_summary %} [{{ song.tag_summary }}]{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit">Add To Setlist</button>
        </form>
    {% else %}
        <p>Every song in your library is already in this setlist. <a href="{{ url_for('setlists.songs') }}">Add more songs</a>.</p>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='setlist.js') }}" defer></script>
{% endblock %}
